--修正会员卡表的重复记录<第一次没有执行完毕，再处理一次>
delete from PUB_IC_INFO where not Exists(select * from PUB_CUSTOMER where TENANT_ID=PUB_IC_INFO.TENANT_ID and CUST_ID=PUB_IC_INFO.CLIENT_ID and CUST_CODE=PUB_IC_INFO.IC_CARDNO and UNION_ID=PUB_IC_INFO.UNION_ID);

--20110910后的数据全部重报
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='STK_STOCKORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='SAL_SALESORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='STO_CHANGEORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='STK_INDENTORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='SAL_INDENTORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='ACC_IOROORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='ACC_TRANSORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='ACC_RECVORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='ACC_PAYORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='ACC_CLOSE_FORDAY' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='RCK_DAYS_CLOSE' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='RCK_MONTH_CLOSE' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='SAL_IC_GLIDE' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='SAL_PRICEORDER' and TIME_STAMP>21772800;
update SYS_SYNC_CTRL set TIME_STAMP=21772800 where TABLE_NAME='STO_PRINTORDER' and TIME_STAMP>21772800;

--清理掉无效盘点单
delete from STO_PRINTDATA where exists(select TENANT_ID,PRINT_DATE,SHOP_ID from STO_PRINTORDER where TENANT_ID=STO_PRINTDATA.TENANT_ID and SHOP_ID=STO_PRINTDATA.SHOP_ID and PRINT_DATE=STO_PRINTDATA.PRINT_DATE and CHK_DATE is null);
delete from STO_PRINTORDER where CHK_DATE is null;

--添加打印次数及打印人
alter table STK_STOCKORDER add PRINT_TIMES int NULL;
alter table STK_STOCKORDER add PRINT_USER varchar(36) NULL;

alter table SAL_SALESORDER add PRINT_TIMES int NULL;
alter table SAL_SALESORDER add PRINT_USER varchar(36) NULL;

alter table STO_CHANGEORDER add PRINT_TIMES int NULL;
alter table STO_CHANGEORDER add PRINT_USER varchar(36) NULL;

alter table SAL_INDENTORDER add PRINT_TIMES int NULL;
alter table SAL_INDENTORDER add PRINT_USER varchar(36) NULL;

alter table STK_INDENTORDER add PRINT_TIMES int NULL;
alter table STK_INDENTORDER add PRINT_USER varchar(36) NULL;

alter table STO_PRINTORDER add PRINT_TIMES int NULL;
alter table STO_PRINTORDER add PRINT_USER varchar(36) NULL;

alter table SAL_PRICEORDER add PRINT_TIMES int NULL;
alter table SAL_PRICEORDER add PRINT_USER varchar(36) NULL;

--指令类型
insert into PUB_PARAMS(CODE_ID,CODE_NAME,TYPE_CODE,COMM,TIME_STAMP) values('1','SQL','COMMAND_TYPE','00',5497000);
insert into PUB_PARAMS(CODE_ID,CODE_NAME,TYPE_CODE,COMM,TIME_STAMP) values('2','EXE','COMMAND_TYPE','00',5497000);
insert into PUB_PARAMS(CODE_ID,CODE_NAME,TYPE_CODE,COMM,TIME_STAMP) values('3','ACTION','COMMAND_TYPE','00',5497000);
--指令状态
insert into PUB_PARAMS(CODE_ID,CODE_NAME,TYPE_CODE,COMM,TIME_STAMP) values('1','待执行','COMMAND_STATUS','00',5497000);
insert into PUB_PARAMS(CODE_ID,CODE_NAME,TYPE_CODE,COMM,TIME_STAMP) values('2','已执行','COMMAND_STATUS','00',5497000);
 
--服务端推送指令
CREATE TABLE SYS_COMMAND(
  ROWS_ID char(36) NOT NULL,
        --企业代码
	TENANT_ID int NOT NULL ,
        --门店代码
	SHOP_ID varchar (13) NOT NULL ,
        --指令类型
	COMMAND_TYPE varchar (1) NOT NULL ,
        --指令说明{1 sql语句 2 exe执行文件的下载路径 3 程序内的action名}
	COMMAND_TEXT varchar (3000) NOT NULL ,
        --执行状态 
	COMMAND_STATUS varchar (1) NOT NULL ,
	CONSTRAINT SYS_COMMAND PRIMARY KEY   
	(
		ROWS_ID
	) 
);

//清理日月台账，后新结转

delete from RCK_DAYS_CLOSE;
delete from RCK_MONTH_CLOSE;

//处理卡号重复问题

Begin Transaction;

CREATE TABLE Temp_425003022 (
        --会员编码<不计名卡时，为#>
	CLIENT_ID varchar (36) NOT NULL ,
        --企业代码
	TENANT_ID int NOT NULL ,
        --商盟编号<不是商盟卡时，为#>
	UNION_ID varchar (36) NOT NULL ,
        --IC卡号
	IC_CARDNO varchar (36) NOT NULL ,
        --发卡日期
	CREA_DATE varchar (10) NOT NULL ,
        --有效截止日期
	END_DATE varchar (10) NULL ,
        --发卡用户
	CREA_USER varchar (36) NOT NULL ,
        --摘要
	IC_INFO varchar (100) NOT NULL ,
        --IC卡状态
	IC_STATUS varchar (1) NOT NULL ,
        --IC卡类型
	IC_TYPE varchar (1) NOT NULL ,
        --累计积分
	ACCU_INTEGRAL decimal(10, 3) NULL ,
        --使用积分
	RULE_INTEGRAL decimal(18, 3) NULL ,
        --可用积分
	INTEGRAL decimal(18, 3) NULL ,
        --可用余额
	BALANCE decimal(18, 3) NULL ,
        --消费密码
	PASSWRD varchar (50) NULL ,
        --最近使用日期
	USING_DATE varchar (10) NULL ,
        --通讯标志
	COMM varchar (2) NOT NULL CONSTRAINT DF_PUB_IC_INFO_COMM DEFAULT ('00'),
        --时间戳 从2011-01-01开始的秒数
  TIME_STAMP bigint NOT NULL,
  Primary Key(TENANT_ID,UNION_ID,CLIENT_ID)        
    
);

Insert Into Temp_425003022 (CLIENT_ID,TENANT_ID,UNION_ID,IC_CARDNO,CREA_DATE,END_DATE,CREA_USER,IC_INFO,IC_STATUS,IC_TYPE,ACCU_INTEGRAL,RULE_INTEGRAL,INTEGRAL,BALANCE,PASSWRD,USING_DATE,COMM,TIME_STAMP) 
 Select CLIENT_ID,TENANT_ID,UNION_ID,IC_CARDNO,CREA_DATE,END_DATE,CREA_USER,IC_INFO,IC_STATUS,IC_TYPE,ACCU_INTEGRAL,RULE_INTEGRAL,INTEGRAL,BALANCE,PASSWRD,USING_DATE,COMM,TIME_STAMP From PUB_IC_INFO;

Drop Table PUB_IC_INFO;
Alter Table Temp_425003022 Rename To PUB_IC_INFO;

CREATE INDEX IX_PUB_IC_INFO_TENANT_ID ON PUB_IC_INFO(TENANT_ID);
CREATE INDEX IX_PUB_IC_INFO_TIME_STAMP ON PUB_IC_INFO(TENANT_ID,TIME_STAMP);
CREATE INDEX IX_PUB_IC_INFO_CLIENT_ID ON PUB_IC_INFO(TENANT_ID,CLIENT_ID);
CREATE INDEX IX_PUB_IC_INFO_IC_CARDNO ON PUB_IC_INFO(TENANT_ID,IC_CARDNO);

Commit Transaction;

